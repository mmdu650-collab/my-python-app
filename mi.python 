import sqlite3
import logging
import re
import os
from aiogram import Bot, Dispatcher, executor, types
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, ReplyKeyboardMarkup, KeyboardButton
from aiogram.contrib.fsm_storage.memory import MemoryStorage
from aiogram.dispatcher import FSMContext
from aiogram.dispatcher.filters.state import State, StatesGroup
from datetime import datetime, timedelta

# ==========================
# ØªÙ†Ø¸ÛŒÙ…Ø§Øª
# ==========================


API_TOKEN = "8296362457:AAHvChgZ_b_lHx-lsURcFQQB-8BS-YAWmPY"  # ØªÙˆÚ©Ù† Ø±Ø¨Ø§Øª Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯
ADMIN_ID = 6445107015  # Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ Ø§Ø¯Ù…ÛŒÙ†
SUBSCRIPTION_LOCK = True  # Ù‚ÙÙ„ Ø¹Ø¶ÙˆÛŒØª Ø¯Ø± Ú©Ø§Ù†Ø§Ù„

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler("bot.log"),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

bot = Bot(token=API_TOKEN)
dp = Dispatcher(bot, storage=MemoryStorage())

# ==========================
# Ø¯ÛŒØªØ§Ø¨ÛŒØ³
# ==========================

def get_db_connection():
    try:
        db = sqlite3.connect("bot.db", check_same_thread=False)
        db.execute("PRAGMA foreign_keys = ON")
        return db
    except sqlite3.Error as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³: {e}")
        return None

db = get_db_connection()
if db is None:
    logger.error("Ø¹Ø¯Ù… ØªÙˆØ§Ù†Ø§ÛŒÛŒ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³. Ø±Ø¨Ø§Øª Ù…ØªÙˆÙ‚Ù Ù…ÛŒâ€ŒØ´ÙˆØ¯.")
    exit(1)

cursor = db.cursor()

try:
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS users (
        user_id INTEGER PRIMARY KEY,
        username TEXT,
        first_name TEXT,
        last_name TEXT,
        points REAL DEFAULT 0,
        invites INTEGER DEFAULT 0,
        invited_by INTEGER DEFAULT 0,
        joined_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )
    """)
    
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS channels (
        channel_id TEXT PRIMARY KEY,
        channel_name TEXT,
        required INTEGER DEFAULT 1
    )
    """)
    
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS admins (
        user_id INTEGER PRIMARY KEY,
        username TEXT,
        full_name TEXT
    )
    """)
    
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS orders (
        order_id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER,
        order_type TEXT,
        details TEXT,
        amount REAL,
        points_used REAL,
        status TEXT DEFAULT 'pending',
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        completed_at DATETIME,
        username TEXT,
        game_id TEXT
    )
    """)
    
    # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø§Ø¯Ù…ÛŒÙ† Ø§ØµÙ„ÛŒ Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³
    cursor.execute("INSERT OR IGNORE INTO admins (user_id, username, full_name) VALUES (?, ?, ?)", 
                  (ADMIN_ID, "Admin", "Ù…Ø¯ÛŒØ± Ø§ØµÙ„ÛŒ"))
    
    db.commit()
    logger.info("Ø¬Ø¯Ø§ÙˆÙ„ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù†Ø¯")

except sqlite3.Error as e:
    logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø¯Ø§ÙˆÙ„: {e}")

# Ù†Ø±Ø® ØªØ¨Ø¯ÛŒÙ„ Ø§Ù…ØªÛŒØ§Ø² Ø¨Ù‡ Ø§Ø±Ø²Ù‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒâ€ŒÙ‡Ø§
conversion_rates = {
    "uc": {
        48: 60,
        75: 120,
        95: 240,
        120: 360
    },
    "cp": {
        40: 80,
        65: 160,
        85: 240,
        110: 320
    },
    "diamonds": {
        35: 50,
        60: 100,
        80: 200,
        100: 300
    }
}

# ==========================
# Ø§Ø³ØªÛŒØªâ€ŒÙ‡Ø§
# ==========================

class OrderState(StatesGroup):
    waiting_for_game_id = State()
    waiting_for_codm_id = State()
    waiting_for_freefire_id = State()

class AdminState(StatesGroup):
    waiting_for_broadcast = State()
    waiting_for_channel = State()
    waiting_for_admin = State()

# ==========================
# ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ
# ==========================

async def check_subscription_and_notify(user_id, message=None, callback_query=None):
    """Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª Ú©Ø§Ø±Ø¨Ø± Ùˆ Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø¯Ø± ØµÙˆØ±Øª Ø¹Ø¯Ù… Ø¹Ø¶ÙˆÛŒØª"""
    if not SUBSCRIPTION_LOCK:
        return True
    
    channels = get_channels()
    if not channels:
        return True
    
    for channel_id, channel_name in channels:
        try:
            member = await bot.get_chat_member(chat_id=channel_id, user_id=user_id)
            if member.status not in ['member', 'administrator', 'creator']:
                # Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø¹Ø¶ÙˆÛŒØª
                kb = InlineKeyboardMarkup()
                for ch_id, ch_name in channels:
                    kb.add(InlineKeyboardButton(f"ğŸ”— {ch_name}", url=f"https://t.me/{ch_id[1:]}"))
                kb.add(InlineKeyboardButton("âœ… Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª", callback_data="check_sub"))
                
                text = "ğŸ“¢ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø±Ø¨Ø§ØªØŒ Ù„Ø·ÙØ§Ù‹ Ø¯Ø± Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø¹Ø¶Ùˆ Ø´ÙˆÛŒØ¯:"
                
                if message:
                    await message.answer(text, reply_markup=kb)
                elif callback_query:
                    await callback_query.message.answer(text, reply_markup=kb)
                
                return False
        except Exception as e:
            logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª Ú©Ø§Ø±Ø¨Ø± {user_id} Ø¯Ø± Ú©Ø§Ù†Ø§Ù„ {channel_id}: {e}")
    
    return True

def add_user(user_id, username="", first_name="", last_name="", invited_by=0):
    try:
        cursor.execute(
            "INSERT OR IGNORE INTO users (user_id, username, first_name, last_name, invited_by) VALUES (?, ?, ?, ?, ?)",
            (user_id, username, first_name, last_name, invited_by)
        )
        db.commit()
        logger.info(f"Ú©Ø§Ø±Ø¨Ø± {user_id} Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯")
        return True
    except sqlite3.Error as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø± {user_id}: {e}")
        return False

def is_user_exists(user_id):
    try:
        cursor.execute("SELECT user_id FROM users WHERE user_id=?", (user_id,))
        return cursor.fetchone() is not None
    except sqlite3.Error as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø± {user_id}: {e}")
        return False

def update_points(user_id, amount):
    try:
        cursor.execute("UPDATE users SET points = points + ? WHERE user_id=?", (amount, user_id))
        db.commit()
        logger.info(f"Ø§Ù…ØªÛŒØ§Ø² Ú©Ø§Ø±Ø¨Ø± {user_id} ØªØºÛŒÛŒØ± Ú©Ø±Ø¯: {amount}")
        return True
    except sqlite3.Error as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡ Ø±ÙˆØ² Ø±Ø³Ø§Ù†ÛŒ Ø§Ù…ØªÛŒØ§Ø² Ú©Ø§Ø±Ø¨Ø± {user_id}: {e}")
        return False

def get_points(user_id):
    try:
        cursor.execute("SELECT points FROM users WHERE user_id=?", (user_id,))
        row = cursor.fetchone()
        return row[0] if row else 0
    except sqlite3.Error as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ù…ØªÛŒØ§Ø² Ú©Ø§Ø±Ø¨Ø± {user_id}: {e}")
        return 0

def update_invites(user_id):
    try:
        cursor.execute("UPDATE users SET invites = invites + 1 WHERE user_id=?", (user_id,))
        db.commit()
        logger.info(f"ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø¹ÙˆØªâ€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± {user_id} Ø§ÙØ²Ø§ÛŒØ´ ÛŒØ§ÙØª")
        return True
    except sqlite3.Error as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡ Ø±ÙˆØ² Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø¹ÙˆØªâ€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± {user_id}: {e}")
        return False

def get_invited_by(user_id):
    try:
        cursor.execute("SELECT invited_by FROM users WHERE user_id=?", (user_id,))
        row = cursor.fetchone()
        return row[0] if row else 0
    except sqlite3.Error as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø¹ÙˆØª Ú©Ù†Ù†Ø¯Ù‡ Ú©Ø§Ø±Ø¨Ø± {user_id}: {e}")
        return 0

def is_admin(user_id):
    try:
        cursor.execute("SELECT user_id FROM admins WHERE user_id=?", (user_id,))
        result = cursor.fetchone()
        return result is not None
    except sqlite3.Error as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ø¨ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø± {user_id}: {e}")
        return False

def get_channels():
    try:
        cursor.execute("SELECT channel_id, channel_name FROM channels WHERE required=1")
        return cursor.fetchall()
    except sqlite3.Error as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§: {e}")
        return []

def add_channel(channel_id, channel_name):
    try:
        cursor.execute(
            "INSERT OR REPLACE INTO channels (channel_id, channel_name) VALUES (?, ?)",
            (channel_id, channel_name)
        )
        db.commit()
        logger.info(f"Ú©Ø§Ù†Ø§Ù„ {channel_id} Ø§ÙØ²ÙˆØ¯Ù‡ Ø´Ø¯")
        return True
    except sqlite3.Error as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ù†Ø§Ù„ {channel_id}: {e}")
        return False

def remove_channel(channel_id):
    try:
        cursor.execute("DELETE FROM channels WHERE channel_id=?", (channel_id,))
        db.commit()
        logger.info(f"Ú©Ø§Ù†Ø§Ù„ {channel_id} Ø­Ø°Ù Ø´Ø¯")
        return True
    except sqlite3.Error as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ú©Ø§Ù†Ø§Ù„ {channel_id}: {e}")
        return False

def add_admin(user_id, username="", full_name=""):
    try:
        cursor.execute(
            "INSERT OR REPLACE INTO admins (user_id, username, full_name) VALUES (?, ?, ?)",
            (user_id, username, full_name)
        )
        db.commit()
        logger.info(f"Ø§Ø¯Ù…ÛŒÙ† {user_id} Ø§ÙØ²ÙˆØ¯Ù‡ Ø´Ø¯")
        return True
    except sqlite3.Error as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ø§Ø¯Ù…ÛŒÙ† {user_id}: {e}")
        return False

def remove_admin(user_id):
    try:
        cursor.execute("DELETE FROM admins WHERE user_id=?", (user_id,))
        db.commit()
        logger.info(f"Ø§Ø¯Ù…ÛŒÙ† {user_id} Ø­Ø°Ù Ø´Ø¯")
        return True
    except sqlite3.Error as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø§Ø¯Ù…ÛŒÙ† {user_id}: {e}")
        return False

def get_admins():
    try:
        cursor.execute("SELECT user_id, username, full_name FROM admins")
        return cursor.fetchall()
    except sqlite3.Error as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø§Ø¯Ù…ÛŒÙ†â€ŒÙ‡Ø§: {e}")
        return []

def main_menu(user_id):
    kb = ReplyKeyboardMarkup(
        resize_keyboard=True,
        row_width=2
    )
    
    kb.row(
        KeyboardButton("ğŸ Ø¯Ø¹ÙˆØª Ø¯ÙˆØ³ØªØ§Ù†"), 
        KeyboardButton("ğŸ“Š Ù¾Ø±ÙˆÙØ§ÛŒÙ„")
    )
    
    kb.row(
        KeyboardButton("ğŸ® Ø¯Ø±ÛŒØ§ÙØª ÛŒÙˆØ³ÛŒ Ø±Ø§ÛŒÚ¯Ø§Ù†"),
        KeyboardButton("âš¡ Ø¯Ø±ÛŒØ§ÙØª CP Ú©Ø§Ù„Ø§Ù")
    )
    
    kb.row(
        KeyboardButton("ğŸ’ Ø¯Ø±ÛŒØ§ÙØª Ø¬Ù… ÙØ±ÛŒ ÙØ§ÛŒØ±"),
        KeyboardButton("ğŸ“– Ø±Ø§Ù‡Ù†Ù…Ø§")
    )
    
    kb.add(KeyboardButton("ğŸ“ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ"))
    
    if is_admin(user_id):
        kb.add(KeyboardButton("âš™ï¸ Ø§Ø¯Ù…ÛŒÙ†"))
    
    return kb

async def check_subscription(user_id):
    if not SUBSCRIPTION_LOCK:
        return True
    
    channels = get_channels()
    for channel_id, channel_name in channels:
        try:
            member = await bot.get_chat_member(chat_id=channel_id, user_id=user_id)
            if member.status not in ['member', 'administrator', 'creator']:
                return False
        except Exception as e:
            logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª Ú©Ø§Ø±Ø¨Ø± {user_id} Ø¯Ø± Ú©Ø§Ù†Ø§Ù„ {channel_id}: {e}")
            return False
    return True

def is_valid_game_id(game_id):
    return re.match(r'^[a-zA-Z0-9]+$', game_id) is not None

def is_valid_codm_id(game_id):
    return re.match(r'^[a-zA-Z0-9]+$', game_id) is not None

def is_valid_freefire_id(game_id):
    return re.match(r'^[a-zA-Z0-9]+$', game_id) is not None

async def notify_inviter(invited_by: int, new_user_id: int, new_user_name: str, new_user_username: str, success: bool):
    """Ø§Ø·Ù„Ø§Ø¹ Ø±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø¹ÙˆØªâ€ŒÚ©Ù†Ù†Ø¯Ù‡"""
    try:
        if success:
            # Ø¯Ø¹ÙˆØª Ù…ÙˆÙÙ‚
            message_text = (
                f"ğŸ‰ Ú©Ø§Ø±Ø¨Ø± {new_user_name} (@{new_user_username or 'Ø¨Ø¯ÙˆÙ† ÛŒÙˆØ²Ø±Ù†ÛŒÙ…'}) Ø¨Ø§ Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ø´Ù…Ø§ Ø¹Ø¶Ùˆ Ø±Ø¨Ø§Øª Ø´Ø¯!\n\n"
                f"âœ… 1 Ø§Ù…ØªÛŒØ§Ø² Ø¨Ù‡ Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯."
            )
        else:
            # Ú©Ø§Ø±Ø¨Ø± Ù‚Ø¨Ù„Ø§Ù‹ Ø¹Ø¶Ùˆ Ø¨ÙˆØ¯Ù‡
            message_text = (
                f"â„¹ï¸ Ú©Ø§Ø±Ø¨Ø± {new_user_name} (@{new_user_username or 'Ø¨Ø¯ÙˆÙ† ÛŒÙˆØ²Ø±Ù†ÛŒÙ…'}) Ù‚Ø¨Ù„Ø§Ù‹ Ø¯Ø± Ø±Ø¨Ø§Øª Ø¹Ø¶Ùˆ Ø¨ÙˆØ¯Ù‡ Ø§Ø³Øª.\n\n"
                f"âŒ Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ù‚Ø¨Ù„Ø§Ù‹ Ø¹Ø¶Ùˆ Ø¨ÙˆØ¯Ù‡ØŒ Ø¨Ù†Ø§Ø¨Ø±Ø§ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø²ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ú©Ø±Ø¯ÛŒØ¯."
            )
        
        await bot.send_message(invited_by, message_text)
        
    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Ø¯Ø¹ÙˆØªâ€ŒÚ©Ù†Ù†Ø¯Ù‡ {invited_by}: {e}")

# ==========================
# Ø§Ø³ØªØ§Ø±Øª
# ==========================

@dp.message_handler(commands=["start"])
async def start(message: types.Message):
    user_id = message.from_user.id
    username = message.from_user.username or ""
    first_name = message.from_user.first_name or ""
    last_name = message.from_user.last_name or ""
    
    args = message.get_args()
    invited_by = 0
    
    is_new_user = not is_user_exists(user_id)
    user_name = f"{first_name} {last_name}".strip() or "ÛŒÚ© Ú©Ø§Ø±Ø¨Ø±"
    
    if args and args.isdigit():
        invited_by = int(args)
        
        if invited_by != user_id and is_user_exists(invited_by):
            if is_new_user:
                # Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ - Ø«Ø¨Øª Ù†Ø§Ù… Ùˆ Ø¯Ø§Ø¯Ù† Ø§Ù…ØªÛŒØ§Ø²
                add_user(user_id, username, first_name, last_name, invited_by)
                update_points(user_id, 1)  # Ø§Ù…ØªÛŒØ§Ø² Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯
                update_points(invited_by, 1)  # Ø§Ù…ØªÛŒØ§Ø² Ø¨Ù‡ Ø¯Ø¹ÙˆØª Ú©Ù†Ù†Ø¯Ù‡
                update_invites(invited_by)  # Ø§ÙØ²Ø§ÛŒØ´ ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø¹ÙˆØªâ€ŒÙ‡Ø§
                
                # Ø§Ø·Ù„Ø§Ø¹ Ù…ÙˆÙÙ‚ Ø¨Ù‡ Ø¯Ø¹ÙˆØªâ€ŒÚ©Ù†Ù†Ø¯Ù‡
                await notify_inviter(invited_by, user_id, user_name, username, True)
                
                welcome_text = f"""ğŸ‰ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ {first_name}!

âœ… Ø¨Ù‡ Ù¾Ø§Ø³ Ø¹Ø¶ÙˆÛŒØª Ø§Ø² Ø·Ø±ÛŒÙ‚ Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØªØŒ 1 Ø§Ù…ØªÛŒØ§Ø² Ù‡Ø¯ÛŒÙ‡ Ø¯Ø±ÛŒØ§ÙØª Ú©Ø±Ø¯ÛŒØ¯!"""
            else:
                # Ú©Ø§Ø±Ø¨Ø± Ù‚Ø¯ÛŒÙ…ÛŒ - ÙÙ‚Ø· Ø§Ø·Ù„Ø§Ø¹ Ø¨Ù‡ Ø¯Ø¹ÙˆØª Ú©Ù†Ù†Ø¯Ù‡
                welcome_text = "âœ… Ø´Ù…Ø§ Ù‚Ø¨Ù„Ø§Ù‹ Ø¯Ø± Ø±Ø¨Ø§Øª Ø¹Ø¶Ùˆ Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯!"
                
                # Ø§Ø·Ù„Ø§Ø¹ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨Ù‡ Ø¯Ø¹ÙˆØªâ€ŒÚ©Ù†Ù†Ø¯Ù‡
                await notify_inviter(invited_by, user_id, user_name, username, False)
        else:
            # Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ù†Ø§Ù…Ø¹ØªØ¨Ø±
            welcome_text = "ğŸ‘‹ Ø¨Ù‡ Ø±Ø¨Ø§Øª Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!"
            if is_new_user:
                add_user(user_id, username, first_name, last_name)
    else:
        # Ø´Ø±ÙˆØ¹ Ø¨Ø¯ÙˆÙ† Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª
        if is_new_user:
            add_user(user_id, username, first_name, last_name)
            welcome_text = "ğŸ‘‹ Ø¨Ù‡ Ø±Ø¨Ø§Øª Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!"
        else:
            welcome_text = "âœ… Ø´Ù…Ø§ Ù‚Ø¨Ù„Ø§Ù‹ Ø¯Ø± Ø±Ø¨Ø§Øª Ø¹Ø¶Ùˆ Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯!"
    
    if not await check_subscription(user_id):
        channels = get_channels()
        kb = InlineKeyboardMarkup()
        for channel_id, channel_name in channels:
            kb.add(InlineKeyboardButton(f"ğŸ”— {channel_name}", url=f"https://t.me/{channel_id[1:]}"))
        kb.add(InlineKeyboardButton("âœ… Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª", callback_data="check_sub"))
        
        await message.answer(
            "ğŸ“¢ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø±Ø¨Ø§ØªØŒ Ù„Ø·ÙØ§Ù‹ Ø¯Ø± Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø¹Ø¶Ùˆ Ø´ÙˆÛŒØ¯:",
            reply_markup=kb
        )
        return
    
    await message.answer(
        f"""{welcome_text}

ğŸ® Ø¯Ø± Ø§ÛŒÙ† Ø±Ø¨Ø§Øª Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯:
â€¢ Ø¨Ø§ Ø¯Ø¹ÙˆØª Ø§Ø² Ø¯ÙˆØ³ØªØ§Ù† Ø§Ù…ØªÛŒØ§Ø² Ú©Ø³Ø¨ Ú©Ù†ÛŒØ¯
â€¢ Ø§Ù…ØªÛŒØ§Ø²Ù‡Ø§ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù‡ Ø§Ø±Ø²Ù‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù ØªØ¨Ø¯ÛŒÙ„ Ú©Ù†ÛŒØ¯

ğŸ“Š Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø§Ø² Ù…Ù†ÙˆÛŒ Ø²ÛŒØ± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:""",
        reply_markup=main_menu(user_id)
    )

@dp.callback_query_handler(lambda c: c.data == "check_sub")
async def check_sub_callback(callback_query: types.CallbackQuery):
    user_id = callback_query.from_user.id
    if await check_subscription(user_id):
        await callback_query.message.edit_text(
            "âœ… Ø´Ù…Ø§ Ø¯Ø± ØªÙ…Ø§Ù… Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ Ø¹Ø¶Ùˆ Ù‡Ø³ØªÛŒØ¯. Ø§Ú©Ù†ÙˆÙ† Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø² Ø±Ø¨Ø§Øª Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.",
            reply_markup=None
        )
        await callback_query.message.answer("Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ:", reply_markup=main_menu(user_id))
    else:
        await callback_query.answer("âŒ Ù‡Ù†ÙˆØ² Ø¯Ø± Ø¨Ø±Ø®ÛŒ Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ Ø¹Ø¶Ùˆ Ù†Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯!", show_alert=True)

# ==========================
# Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ Ø¨Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª
# ==========================

@dp.message_handler(lambda m: m.text == "ğŸ“Š Ù¾Ø±ÙˆÙØ§ÛŒÙ„")
async def profile(message: types.Message):
    user_id = message.from_user.id
    
    # Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª
    if not await check_subscription_and_notify(user_id, message=message):
        return
    
    try:
        cursor.execute("SELECT points, invites FROM users WHERE user_id=?", (user_id,))
        data = cursor.fetchone()
        
        if data:
            cursor.execute("SELECT COUNT(*) FROM orders WHERE user_id=?", (user_id,))
            order_count = cursor.fetchone()[0]
            
            text = f"""
ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±: {message.from_user.first_name or 'Ø¨ÛŒâ€ŒÙ†Ø§Ù…'}
â­ Ø§Ù…ØªÛŒØ§Ø²: {data[0]}
ğŸ‘¥ ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø¹ÙˆØªâ€ŒÙ‡Ø§: {data[1]}
ğŸ“¦ ØªØ¹Ø¯Ø§Ø¯ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§: {order_count}

ğŸ”— Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ø´Ù…Ø§: https://t.me/{(await bot.get_me()).username}?start={user_id}

Ù‡Ø± Ø¯Ø¹ÙˆØª Ù…ÙˆÙÙ‚ = Û± Ø§Ù…ØªÛŒØ§Ø² ğŸ’°"""
            await message.answer(text)
        else:
            await message.answer("âŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.")
    except sqlite3.Error as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø± {user_id}: {e}")
        await message.answer("âŒ Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø±Ø® Ø¯Ø§Ø¯.")

@dp.message_handler(lambda m: m.text == "ğŸ Ø¯Ø¹ÙˆØª Ø¯ÙˆØ³ØªØ§Ù†")
async def invite(message: types.Message):
    user_id = message.from_user.id
    
    # Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª
    if not await check_subscription_and_notify(user_id, message=message):
        return
    
    link = f"https://t.me/{(await bot.get_me()).username}?start={user_id}"
    
    # Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø± ÙØ¹Ù„ÛŒ Ú©Ø§Ø±Ø¨Ø±
    cursor.execute("SELECT invites, points FROM users WHERE user_id=?", (user_id,))
    user_data = cursor.fetchone()
    invites_count = user_data[0] if user_data else 0
    points = user_data[1] if user_data else 0
    
    text = f"""
ğŸ Ø³ÛŒØ³ØªÙ… Ø¯Ø¹ÙˆØª Ø¯ÙˆØ³ØªØ§Ù†

ğŸ“Š Ø¢Ù…Ø§Ø± ÙØ¹Ù„ÛŒ Ø´Ù…Ø§:
ğŸ‘¥ ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø¹ÙˆØªâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙÙ‚: {invites_count}
â­ Ø§Ù…ØªÛŒØ§Ø²Ù‡Ø§ÛŒ Ú©Ø³Ø¨ Ø´Ø¯Ù‡ Ø§Ø² Ø¯Ø¹ÙˆØª: {points}

ğŸ”— Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ø´Ù…Ø§: 
{link}

ğŸ“‹ Ø´Ø±Ø§ÛŒØ· Ø¯Ø¹ÙˆØª:
âœ… Ù‡Ø± Ø¯Ø¹ÙˆØª Ù…ÙˆÙÙ‚ = Û± Ø§Ù…ØªÛŒØ§Ø² Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§
âœ… Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ù‡Ù… Û± Ø§Ù…ØªÛŒØ§Ø² Ù‡Ø¯ÛŒÙ‡ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯
âŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù‚Ø¯ÛŒÙ…ÛŒ Ø§Ù…ØªÛŒØ§Ø²ÛŒ Ù†Ø¯Ø§Ø±Ù†Ø¯

ğŸ’° Ø§Ù…ØªÛŒØ§Ø²Ù‡Ø§ Ù‚Ø§Ø¨Ù„ ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø§Ø±Ø²Ù‡Ø§ÛŒ Ø±Ø§ÛŒÚ¯Ø§Ù† Ø¨Ø§Ø²ÛŒâ€ŒÙ‡Ø§ Ù‡Ø³ØªÙ†Ø¯!"""
    
    await message.answer(text)

@dp.message_handler(lambda m: m.text == "ğŸ® Ø¯Ø±ÛŒØ§ÙØª ÛŒÙˆØ³ÛŒ Ø±Ø§ÛŒÚ¯Ø§Ù†")
async def convert_uc(message: types.Message):
    user_id = message.from_user.id
    
    # Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª
    if not await check_subscription_and_notify(user_id, message=message):
        return
    
    points = get_points(user_id)
    
    if points < 48:
        await message.answer("âŒ Ø­Ø¯Ø§Ù‚Ù„ Ø§Ù…ØªÛŒØ§Ø² Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª ÛŒÙˆØ³ÛŒ Û´Û¸ Ø§Ù…ØªÛŒØ§Ø² Ø§Ø³Øª.")
        return
    
    kb = InlineKeyboardMarkup()
    for point, uc_amount in conversion_rates["uc"].items():
        if points >= point:
            kb.add(InlineKeyboardButton(f"{point} Ø§Ù…ØªÛŒØ§Ø² â†’ {uc_amount} ÛŒÙˆØ³ÛŒ", callback_data=f"uc_{point}"))
    kb.add(InlineKeyboardButton("âŒ Ø§Ù†ØµØ±Ø§Ù", callback_data="cancel"))
    
    await message.answer("ğŸ® Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ù‚Ø¯Ø§Ø± ÛŒÙˆØ³ÛŒ:", reply_markup=kb)

@dp.message_handler(lambda m: m.text == "âš¡ Ø¯Ø±ÛŒØ§ÙØª CP Ú©Ø§Ù„Ø§Ù")
async def convert_cp(message: types.Message):
    user_id = message.from_user.id
    
    # Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª
    if not await check_subscription_and_notify(user_id, message=message):
        return
    
    points = get_points(user_id)
    
    if points < 40:
        await message.answer("âŒ Ø­Ø¯Ø§Ù‚Ù„ Ø§Ù…ØªÛŒØ§Ø² Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª CP Û´Û° Ø§Ù…ØªÛŒØ§Ø² Ø§Ø³Øª.")
        return
    
    kb = InlineKeyboardMarkup()
    for point, cp_amount in conversion_rates["cp"].items():
        if points >= point:
            kb.add(InlineKeyboardButton(f"{point} Ø§Ù…ØªÛŒØ§Ø² â†’ {cp_amount} CP", callback_data=f"cp_{point}"))
    kb.add(InlineKeyboardButton("âŒ Ø§Ù†ØµØ±Ø§Ù", callback_data="cancel"))
    
    await message.answer("âš¡ Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ù‚Ø¯Ø§Ø± CP:", reply_markup=kb)

@dp.message_handler(lambda m: m.text == "ğŸ’ Ø¯Ø±ÛŒØ§ÙØª Ø¬Ù… ÙØ±ÛŒ ÙØ§ÛŒØ±")
async def convert_diamonds(message: types.Message):
    user_id = message.from_user.id
    
    # Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª
    if not await check_subscription_and_notify(user_id, message=message):
        return
    
    points = get_points(user_id)
    
    if points < 35:
        await message.answer("âŒ Ø­Ø¯Ø§Ù‚Ù„ Ø§Ù…ØªÛŒØ§Ø² Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø¬Ù… Û³Ûµ Ø§Ù…ØªÛŒØ§Ø² Ø§Ø³Øª.")
        return
    
    kb = InlineKeyboardMarkup()
    for point, diamonds_amount in conversion_rates["diamonds"].items():
        if points >= point:
            kb.add(InlineKeyboardButton(f"{point} Ø§Ù…ØªÛŒØ§Ø² â†’ {diamonds_amount} Ø¬Ù…", callback_data=f"diamonds_{point}"))
    kb.add(InlineKeyboardButton("âŒ Ø§Ù†ØµØ±Ø§Ù", callback_data="cancel"))
    
    await message.answer("ğŸ’ Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ù‚Ø¯Ø§Ø± Ø¬Ù…:", reply_markup=kb)

@dp.message_handler(lambda m: m.text == "ğŸ“– Ø±Ø§Ù‡Ù†Ù…Ø§")
async def help_message(message: types.Message):
    user_id = message.from_user.id
    
    # Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª
    if not await check_subscription_and_notify(user_id, message=message):
        return
    
    help_text = """ğŸ“– Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø±Ø¨Ø§Øª Ø§Ø±Ø² Ø±Ø§ÛŒÚ¯Ø§Ù†

ğŸ® Ù†Ø±Ø® ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ ÛŒÙˆØ³ÛŒ (PUBG):
â€¢ Û´Û¸ Ø§Ù…ØªÛŒØ§Ø² â†’ Û¶Û° ÛŒÙˆØ³ÛŒ
â€¢ Û·Ûµ Ø§Ù…ØªÛŒØ§Ø² â†’ Û±Û²Û° ÛŒÙˆØ³ÛŒ
â€¢ Û¹Ûµ Ø§Ù…ØªÛŒØ§Ø² â†’ Û²Û´Û° ÛŒÙˆØ³ÛŒ
â€¢ Û±Û²Û° Ø§Ù…ØªÛŒØ§Ø² â†’ Û³Û¶Û° ÛŒÙˆØ³ÛŒ

âš¡ Ù†Ø±Ø® ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ CP (Call of Duty Mobile):
â€¢ Û´Û° Ø§Ù…ØªÛŒØ§Ø² â†’ Û¸Û° CP
â€¢ Û¶Ûµ Ø§Ù…ØªÛŒØ§Ø² â†’ Û±Û¶Û° CP
â€¢ Û¸Ûµ Ø§Ù…ØªÛŒØ§Ø² â†’ Û²Û´Û° CP
â€¢ Û±Û±Û° Ø§Ù…ØªÛŒØ§Ø² â†’ Û³Û²Û° CP

ğŸ’ Ù†Ø±Ø® ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø¬Ù… (Free Fire):
â€¢ Û³Ûµ Ø§Ù…ØªÛŒØ§Ø² â†’ ÛµÛ° Ø¬Ù…
â€¢ Û¶Û° Ø§Ù…ØªÛŒØ§Ø² â†’ Û±Û°Û° Ø¬Ù…
â€¢ Û¸Û° Ø§Ù…ØªÛŒØ§Ø² â†’ Û²Û°Û° Ø¬Ù…
â€¢ Û±Û°Û° Ø§Ù…ØªÛŒØ§Ø² â†’ Û³Û°Û° Ø¬Ù…

ğŸ Ø³ÛŒØ³ØªÙ… Ø¯Ø¹ÙˆØª:
â€¢ ÙÙ‚Ø· Ø¯Ø¹ÙˆØªâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙÙ‚ = Û± Ø§Ù…ØªÛŒØ§Ø²
â€¢ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù‚Ø¯ÛŒÙ…ÛŒ Ø§Ù…ØªÛŒØ§Ø²ÛŒ Ù†Ø¯Ø§Ø±Ù†Ø¯
â€¢ Ø§Ø² Ù„ÛŒÙ†Ú© Ø§Ø®ØªØµØ§ØµÛŒ Ø®ÙˆØ¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯

ğŸ“ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ: Ø¨Ø±Ø§ÛŒ Ø³ÙˆØ§Ù„Ø§Øª Ùˆ Ù…Ø´Ú©Ù„Ø§Øª Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§Ø´ÛŒØ¯"""
    
    await message.answer(help_text)

@dp.message_handler(lambda m: m.text == "ğŸ“ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ")
async def support_message(message: types.Message):
    user_id = message.from_user.id
    
    # Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª
    if not await check_subscription_and_notify(user_id, message=message):
        return
    
    support_text = """ğŸ“ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ

Ø¨Ø±Ø§ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ùˆ Ø¯Ø±ÛŒØ§ÙØª Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ Ø¨ÛŒØ´ØªØ±ØŒ Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.

ğŸ‘¨â€ğŸ’» Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒÛŒ 24 Ø³Ø§Ø¹ØªÙ‡"""
    
    await message.answer(support_text)

# ==========================
# Ù¾Ø±Ø¯Ø§Ø²Ø´ callbackâ€ŒÙ‡Ø§ Ø¨Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª
# ==========================

@dp.callback_query_handler(lambda c: c.data.startswith("uc_"))
async def uc_order(call: types.CallbackQuery, state: FSMContext):
    user_id = call.from_user.id
    
    # Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª
    if not await check_subscription_and_notify(user_id, callback_query=call):
        return
    
    if call.data == "cancel":
        await call.message.edit_text("âŒ Ø¹Ù…Ù„ÛŒØ§Øª Ù„ØºÙˆ Ø´Ø¯.")
        return
    
    points_used = int(call.data.split("_")[1])
    uc_amount = conversion_rates["uc"][points_used]
    
    current_points = get_points(user_id)
    
    if current_points < points_used:
        await call.answer("âŒ Ø§Ù…ØªÛŒØ§Ø² Ú©Ø§ÙÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯!", show_alert=True)
        return
    
    update_points(user_id, -points_used)
    
    await state.update_data(points_used=points_used, uc_amount=uc_amount, order_type="uc")
    await call.message.edit_text(
        f"ğŸ® Ù„Ø·ÙØ§Ù‹ Ø¢ÛŒØ¯ÛŒ Ø¨Ø§Ø²ÛŒ Ø®ÙˆØ¯ Ø¯Ø± PUBG Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:\n\n"
        f"ğŸ“Š Ù…Ù‚Ø¯Ø§Ø± ÛŒÙˆØ³ÛŒ: {uc_amount}\n"
        f"â­ Ø§Ù…ØªÛŒØ§Ø² Ù…ØµØ±ÙÛŒ: {points_used}"
    )
    await OrderState.waiting_for_game_id.set()

@dp.callback_query_handler(lambda c: c.data.startswith("cp_"))
async def cp_order(call: types.CallbackQuery, state: FSMContext):
    user_id = call.from_user.id
    
    # Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª
    if not await check_subscription_and_notify(user_id, callback_query=call):
        return
    
    if call.data == "cancel":
        await call.message.edit_text("âŒ Ø¹Ù…Ù„ÛŒØ§Øª Ù„ØºÙˆ Ø´Ø¯.")
        return
    
    points_used = int(call.data.split("_")[1])
    cp_amount = conversion_rates["cp"][points_used]
    
    current_points = get_points(user_id)
    
    if current_points < points_used:
        await call.answer("âŒ Ø§Ù…ØªÛŒØ§Ø² Ú©Ø§ÙÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯!", show_alert=True)
        return
    
    update_points(user_id, -points_used)
    
    await state.update_data(points_used=points_used, cp_amount=cp_amount, order_type="cp")
    await call.message.edit_text(
        f"âš¡ Ù„Ø·ÙØ§Ù‹ Ø¢ÛŒØ¯ÛŒ Ø¨Ø§Ø²ÛŒ Ø®ÙˆØ¯ Ø¯Ø± Call of Duty Mobile Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:\n\n"
        f"ğŸ“Š Ù…Ù‚Ø¯Ø§Ø± CP: {cp_amount}\n"
        f"â­ Ø§Ù…ØªÛŒØ§Ø² Ù…ØµØ±ÙÛŒ: {points_used}"
    )
    await OrderState.waiting_for_codm_id.set()

@dp.callback_query_handler(lambda c: c.data.startswith("diamonds_"))
async def diamonds_order(call: types.CallbackQuery, state: FSMContext):
    user_id = call.from_user.id
    
    # Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª
    if not await check_subscription_and_notify(user_id, callback_query=call):
        return
    
    if call.data == "cancel":
        await call.message.edit_text("âŒ Ø¹Ù…Ù„ÛŒØ§Øª Ù„ØºÙˆ Ø´Ø¯.")
        return
    
    points_used = int(call.data.split("_")[1])
    diamonds_amount = conversion_rates["diamonds"][points_used]
    
    current_points = get_points(user_id)
    
    if current_points < points_used:
        await call.answer("âŒ Ø§Ù…ØªÛŒØ§Ø² Ú©Ø§ÙÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯!", show_alert=True)
        return
    
    update_points(user_id, -points_used)
    
    await state.update_data(points_used=points_used, diamonds_amount=diamonds_amount, order_type="diamonds")
    await call.message.edit_text(
        f"ğŸ’ Ù„Ø·ÙØ§Ù‹ Ø¢ÛŒØ¯ÛŒ Ø¨Ø§Ø²ÛŒ Ø®ÙˆØ¯ Ø¯Ø± Free Fire Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:\n\n"
        f"ğŸ“Š Ù…Ù‚Ø¯Ø§Ø± Ø¬Ù…: {diamonds_amount}\n"
        f"â­ Ø§Ù…ØªÛŒØ§Ø² Ù…ØµØ±ÙÛŒ: {points_used}"
    )
    await OrderState.waiting_for_freefire_id.set()

# ==========================
# Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¢ÛŒØ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ Ø¨Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª
# ==========================

@dp.message_handler(state=OrderState.waiting_for_game_id)
async def process_game_id(message: types.Message, state: FSMContext):
    user_id = message.from_user.id
    
    # Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª
    if not await check_subscription_and_notify(user_id, message=message):
        return
    
    game_id = message.text.strip()
    
    if not is_valid_game_id(game_id):
        await message.answer("âŒ Ø¢ÛŒØ¯ÛŒ Ø¨Ø§Ø²ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø¢ÛŒØ¯ÛŒ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
        return
    
    data = await state.get_data()
    points_used = data['points_used']
    uc_amount = data['uc_amount']
    
    try:
        cursor.execute(
            "INSERT INTO orders (user_id, order_type, details, amount, points_used, username, game_id) VALUES (?, ?, ?, ?, ?, ?, ?)",
            (user_id, "uc", f"Ø¢ÛŒØ¯ÛŒ Ø¨Ø§Ø²ÛŒ: {game_id}", uc_amount, points_used, message.from_user.username or "", game_id)
        )
        db.commit()
    except sqlite3.Error as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø³ÙØ§Ø±Ø´: {e}")
    
    await message.answer(
        f"âœ… Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯!\n\n"
        f"ğŸ® Ù…Ù‚Ø¯Ø§Ø± ÛŒÙˆØ³ÛŒ: {uc_amount}\n"
        f"â­ Ø§Ù…ØªÛŒØ§Ø² Ù…ØµØ±ÙÛŒ: {points_used}\n"
        f"ğŸ†” Ø¢ÛŒØ¯ÛŒ Ø¨Ø§Ø²ÛŒ: {game_id}\n\n"
        f"â³ ÛŒÙˆØ³ÛŒ Ø·ÛŒ Û²Û´ Ø³Ø§Ø¹Øª Ø¨Ù‡ Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯."
    )
    
    admins = get_admins()
    for admin_id, admin_username, admin_name in admins:
        try:
            await bot.send_message(
                admin_id,
                f"ğŸ“¦ Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯!\n\n"
                f"ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±: {message.from_user.first_name} (@{message.from_user.username})\n"
                f"ğŸ“‹ Ù†ÙˆØ¹: ÛŒÙˆØ³ÛŒ Ø±Ø§ÛŒÚ¯Ø§Ù†\n"
                f"ğŸ® Ù…Ù‚Ø¯Ø§Ø±: {uc_amount} ÛŒÙˆØ³ÛŒ\n"
                f"â­ Ø§Ù…ØªÛŒØ§Ø²: {points_used}\n"
                f"ğŸ†” Ø¢ÛŒØ¯ÛŒ Ø¨Ø§Ø²ÛŒ: {game_id}"
            )
        except Exception as e:
            logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ†: {e}")
    
    await state.finish()

@dp.message_handler(state=OrderState.waiting_for_codm_id)
async def process_codm_id(message: types.Message, state: FSMContext):
    user_id = message.from_user.id
    
    # Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª
    if not await check_subscription_and_notify(user_id, message=message):
        return
    
    game_id = message.text.strip()
    
    if not is_valid_codm_id(game_id):
        await message.answer("âŒ Ø¢ÛŒØ¯ÛŒ Ø¨Ø§Ø²ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø¢ÛŒØ¯ÛŒ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
        return
    
    data = await state.get_data()
    points_used = data['points_used']
    cp_amount = data['cp_amount']
    
    try:
        cursor.execute(
            "INSERT INTO orders (user_id, order_type, details, amount, points_used, username, game_id) VALUES (?, ?, ?, ?, ?, ?, ?)",
            (user_id, "cp", f"Ø¢ÛŒØ¯ÛŒ Ø¨Ø§Ø²ÛŒ: {game_id}", cp_amount, points_used, message.from_user.username or "", game_id)
        )
        db.commit()
    except sqlite3.Error as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø³ÙØ§Ø±Ø´: {e}")
    
    await message.answer(
        f"âœ… Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯!\n\n"
        f"âš¡ Ù…Ù‚Ø¯Ø§Ø± CP: {cp_amount}\n"
        f"â­ Ø§Ù…ØªÛŒØ§Ø² Ù…ØµØ±ÙÛŒ: {points_used}\n"
        f"ğŸ†” Ø¢ÛŒØ¯ÛŒ Ø¨Ø§Ø²ÛŒ: {game_id}\n\n"
        f"â³ CP Ø·ÛŒ Û²Û´ Ø³Ø§Ø¹Øª Ø¨Ù‡ Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯."
    )
    
    admins = get_admins()
    for admin_id, admin_username, admin_name in admins:
        try:
            await bot.send_message(
                admin_id,
                f"ğŸ“¦ Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯!\n\n"
                f"ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±: {message.from_user.first_name} (@{message.from_user.username})\n"
                f"ğŸ“‹ Ù†ÙˆØ¹: CP Ú©Ø§Ù„Ø§Ù\n"
                f"âš¡ Ù…Ù‚Ø¯Ø§Ø±: {cp_amount} CP\n"
                f"â­ Ø§Ù…ØªÛŒØ§Ø²: {points_used}\n"
                f"ğŸ†” Ø¢ÛŒØ¯ÛŒ Ø¨Ø§Ø²ÛŒ: {game_id}"
            )
        except Exception as e:
            logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ†: {e}")
    
    await state.finish()

@dp.message_handler(state=OrderState.waiting_for_freefire_id)
async def process_freefire_id(message: types.Message, state: FSMContext):
    user_id = message.from_user.id
    
    # Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª
    if not await check_subscription_and_notify(user_id, message=message):
        return
    
    game_id = message.text.strip()
    
    if not is_valid_freefire_id(game_id):
        await message.answer("âŒ Ø¢ÛŒØ¯ÛŒ Ø¨Ø§Ø²ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø¢ÛŒØ¯ÛŒ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
        return
    
    data = await state.get_data()
    points_used = data['points_used']
    diamonds_amount = data['diamonds_amount']
    
    try:
        cursor.execute(
            "INSERT INTO orders (user_id, order_type, details, amount, points_used, username, game_id) VALUES (?, ?, ?, ?, ?, ?, ?)",
            (user_id, "diamonds", f"Ø¢ÛŒØ¯ÛŒ Ø¨Ø§Ø²ÛŒ: {game_id}", diamonds_amount, points_used, message.from_user.username or "", game_id)
        )
        db.commit()
    except sqlite3.Error as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø³ÙØ§Ø±Ø´: {e}")
    
    await message.answer(
        f"âœ… Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯!\n\n"
        f"ğŸ’ Ù…Ù‚Ø¯Ø§Ø± Ø¬Ù…: {diamonds_amount}\n"
        f"â­ Ø§Ù…ØªÛŒØ§Ø² Ù…ØµØ±ÙÛŒ: {points_used}\n"
        f"ğŸ†” Ø¢ÛŒØ¯ÛŒ Ø¨Ø§Ø²ÛŒ: {game_id}\n\n"
        f"â³ Ø¬Ù… Ø·ÛŒ Û²Û´ Ø³Ø§Ø¹Øª Ø¨Ù‡ Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯."
    )
    
    admins = get_admins()
    for admin_id, admin_username, admin_name in admins:
        try:
            await bot.send_message(
                admin_id,
                f"ğŸ“¦ Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯!\n\n"
                f"ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±: {message.from_user.first_name} (@{message.from_user.username})\n"
                f"ğŸ“‹ Ù†ÙˆØ¹: Ø¬Ù… ÙØ±ÛŒ ÙØ§ÛŒØ±\n"
                f"ğŸ’ Ù…Ù‚Ø¯Ø§Ø±: {diamonds_amount} Ø¬Ù…\n"
                f"â­ Ø§Ù…ØªÛŒØ§Ø²: {points_used}\n"
                f"ğŸ†” Ø¢ÛŒØ¯ÛŒ Ø¨Ø§Ø²ÛŒ: {game_id}"
            )
        except Exception as e:
            logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ†: {e}")
    
    await state.finish()

# ==========================
# Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ†
# ==========================

@dp.message_handler(lambda m: m.text == "âš™ï¸ Ø§Ø¯Ù…ÛŒÙ†")
async def admin_panel(message: types.Message):
    user_id = message.from_user.id
    
    if not is_admin(user_id):
        await message.answer("âŒ Ø´Ù…Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯.")
        return
    
    kb = ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
    kb.row(
        KeyboardButton("ğŸ“¦ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§"), 
        KeyboardButton("ğŸ‘¥ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†")
    )
    kb.row(
        KeyboardButton("ğŸ“Š Ø¢Ù…Ø§Ø± Ø±Ø¨Ø§Øª"), 
        KeyboardButton("ğŸ“¢ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ù‡Ù…Ù‡")
    )
    kb.row(
        KeyboardButton("ğŸ› ï¸ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§"), 
        KeyboardButton("ğŸ‘‘ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø¯Ù…ÛŒÙ†â€ŒÙ‡Ø§")
    )
    kb.add(KeyboardButton("ğŸ”™ Ø¨Ø±Ú¯Ø´Øª"))
    
    await message.answer("ğŸ‘¨â€ğŸ’» Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø¯Ù…ÛŒÙ†", reply_markup=kb)

@dp.message_handler(lambda m: m.text == "ğŸ”™ Ø¨Ø±Ú¯Ø´Øª")
async def back_menu(message: types.Message):
    await message.answer("Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ:", reply_markup=main_menu(message.from_user.id))

@dp.message_handler(lambda m: m.text == "ğŸ“¦ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§")
async def orders_list(message: types.Message):
    if not is_admin(message.from_user.id):
        return
    
    try:
        cursor.execute("""
            SELECT order_id, user_id, order_type, details, amount, points_used, status, created_at, completed_at, username, game_id 
            FROM orders ORDER BY created_at DESC LIMIT 10
        """)
        orders = cursor.fetchall()
        
        if not orders:
            await message.answer("ğŸ“­ Ù‡ÛŒÚ† Ø³ÙØ§Ø±Ø´ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.")
            return
        
        for order in orders:
            if order[2] == "uc":
                order_type = "ğŸ® ÛŒÙˆØ³ÛŒ Ø±Ø§ÛŒÚ¯Ø§Ù†"
            elif order[2] == "cp":
                order_type = "âš¡ CP Ú©Ø§Ù„Ø§Ù"
            elif order[2] == "diamonds":
                order_type = "ğŸ’ Ø¬Ù… ÙØ±ÛŒ ÙØ§ÛŒØ±"
            else:
                order_type = f"ğŸ“‹ {order[2]}"
                
            status_emoji = "âœ…" if order[6] == "completed" else "â³" if order[6] == "pending" else "âŒ"
            
            kb = InlineKeyboardMarkup()
            if order[6] == "pending":
                kb.add(InlineKeyboardButton("âœ… ØªÚ©Ù…ÛŒÙ„ Ø³ÙØ§Ø±Ø´", callback_data=f"complete_{order[0]}"))
            kb.add(InlineKeyboardButton("âŒ Ø­Ø°Ù Ø³ÙØ§Ø±Ø´", callback_data=f"delete_{order[0]}"))
            
            text = f"""
ğŸ“¦ Ø³ÙØ§Ø±Ø´ #{order[0]}
ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±: {order[1]} ({order[9] or 'Ø¨Ø¯ÙˆÙ† ÛŒÙˆØ²Ø±Ù†ÛŒÙ…'})
ğŸ“‹ Ù†ÙˆØ¹: {order_type}
ğŸ” Ø¬Ø²Ø¦ÛŒØ§Øª: {order[3]}
ğŸ’° Ù…Ù‚Ø¯Ø§Ø±: {order[4]} {order[2].upper() if order[2] != 'diamonds' else 'Ø¬Ù…'}
â­ Ø§Ù…ØªÛŒØ§Ø² Ù…ØµØ±ÙÛŒ: {order[5]}
ğŸ†” Ø¢ÛŒØ¯ÛŒ Ø¨Ø§Ø²ÛŒ: {order[10]}
ğŸ“… ØªØ§Ø±ÛŒØ®: {order[7]}
ğŸ”„ ÙˆØ¶Ø¹ÛŒØª: {status_emoji} {order[6]}"""
            await message.answer(text, reply_markup=kb)
    except sqlite3.Error as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø³ÙØ§Ø±Ø´Ø§Øª: {e}")
        await message.answer("âŒ Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø³ÙØ§Ø±Ø´Ø§Øª Ø±Ø® Ø¯Ø§Ø¯.")

@dp.message_handler(lambda m: m.text == "ğŸ‘¥ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†")
async def users_list(message: types.Message):
    if not is_admin(message.from_user.id):
        return
    
    try:
        cursor.execute("SELECT COUNT(*) FROM users")
        total_users = cursor.fetchone()[0]
        
        cursor.execute("SELECT COUNT(*) FROM users WHERE DATE(joined_at) = DATE('now')")
        today_users = cursor.fetchone()[0]
        
        cursor.execute("SELECT SUM(points) FROM users")
        total_points = cursor.fetchone()[0] or 0
        
        cursor.execute("SELECT SUM(invites) FROM users")
        total_invites = cursor.fetchone()[0] or 0
        
        text = f"""
ğŸ“Š Ø¢Ù…Ø§Ø± Ú©Ø§Ø±Ø¨Ø±Ø§Ù†

ğŸ‘¤ Ú©Ù„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†: {total_users}
ğŸ“ˆ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø§Ù…Ø±ÙˆØ²: {today_users}
â­ Ú©Ù„ Ø§Ù…ØªÛŒØ§Ø²Ù‡Ø§: {total_points}
ğŸ Ú©Ù„ Ø¯Ø¹ÙˆØªâ€ŒÙ‡Ø§: {total_invites}"""
        
        await message.answer(text)
    except sqlite3.Error as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø± Ú©Ø§Ø±Ø¨Ø±Ø§Ù†: {e}")
        await message.answer("âŒ Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø± Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø±Ø® Ø¯Ø§Ø¯.")

@dp.message_handler(lambda m: m.text == "ğŸ“Š Ø¢Ù…Ø§Ø± Ø±Ø¨Ø§Øª")
async def bot_stats(message: types.Message):
    if not is_admin(message.from_user.id):
        return
    
    try:
        cursor.execute("SELECT COUNT(*) FROM orders")
        total_orders = cursor.fetchone()[0]
        
        cursor.execute("SELECT COUNT(*) FROM orders WHERE status = 'completed'")
        completed_orders = cursor.fetchone()[0]
        
        cursor.execute("SELECT COUNT(*) FROM orders WHERE status = 'pending'")
        pending_orders = cursor.fetchone()[0]
        
        cursor.execute("SELECT SUM(amount) FROM orders WHERE status = 'completed'")
        total_amount = cursor.fetchone()[0] or 0
        
        text = f"""
ğŸ“ˆ Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ Ø±Ø¨Ø§Øª

ğŸ“¦ Ú©Ù„ Ø³ÙØ§Ø±Ø´Ø§Øª: {total_orders}
âœ… Ø³ÙØ§Ø±Ø´Ø§Øª ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡: {completed_orders}
â³ Ø³ÙØ§Ø±Ø´Ø§Øª Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±: {pending_orders}
ğŸ’° Ú©Ù„ Ø§Ø±Ø² Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ: {total_amount}"""
        
        await message.answer(text)
    except sqlite3.Error as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø± Ø±Ø¨Ø§Øª: {e}")
        await message.answer("âŒ Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø± Ø±Ø¨Ø§Øª Ø±Ø® Ø¯Ø§Ø¯.")

@dp.message_handler(lambda m: m.text == "ğŸ“¢ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ù‡Ù…Ù‡")
async def broadcast_message(message: types.Message, state: FSMContext):
    if not is_admin(message.from_user.id):
        return
    
    await message.answer("ğŸ“¢ Ù„Ø·ÙØ§Ù‹ Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:")
    await AdminState.waiting_for_broadcast.set()

@dp.message_handler(state=AdminState.waiting_for_broadcast)
async def process_broadcast(message: types.Message, state: FSMContext):
    if not is_admin(message.from_user.id):
        await state.finish()
        return
    
    try:
        cursor.execute("SELECT user_id FROM users")
        users = cursor.fetchall()
        
        success = 0
        failed = 0
        
        for (user_id,) in users:
            try:
                await bot.copy_message(user_id, message.from_user.id, message.message_id)
                success += 1
            except Exception as e:
                failed += 1
        
        await message.answer(f"""
âœ… Ø§Ø±Ø³Ø§Ù„ Ù‡Ù…Ú¯Ø§Ù†ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯

âœ… Ù…ÙˆÙÙ‚: {success}
âŒ Ù†Ø§Ù…ÙˆÙÙ‚: {failed}
        """)
        
    except sqlite3.Error as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù‡Ù…Ú¯Ø§Ù†ÛŒ: {e}")
        await message.answer("âŒ Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù‡Ù…Ú¯Ø§Ù†ÛŒ Ø±Ø® Ø¯Ø§Ø¯.")
    
    await state.finish()

@dp.message_handler(lambda m: m.text == "ğŸ› ï¸ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§")
async def manage_channels(message: types.Message):
    if not is_admin(message.from_user.id):
        return
    
    kb = InlineKeyboardMarkup()
    kb.add(InlineKeyboardButton("â• Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ù†Ø§Ù„", callback_data="add_channel"))
    kb.add(InlineKeyboardButton("ğŸ“‹ Ù„ÛŒØ³Øª Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§", callback_data="list_channels"))
    kb.add(InlineKeyboardButton("ğŸ”“ Ù‚ÙÙ„ Ø¹Ø¶ÙˆÛŒØª", callback_data="toggle_sub_lock"))
    
    status = "ÙØ¹Ø§Ù„" if SUBSCRIPTION_LOCK else "ØºÛŒØ±ÙØ¹Ø§Ù„"
    await message.answer(f"ğŸ› ï¸ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§\n\nğŸ”’ Ù‚ÙÙ„ Ø¹Ø¶ÙˆÛŒØª: {status}", reply_markup=kb)

@dp.message_handler(lambda m: m.text == "ğŸ‘‘ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø¯Ù…ÛŒÙ†â€ŒÙ‡Ø§")
async def manage_admins(message: types.Message):
    if not is_admin(message.from_user.id):
        return
    
    kb = InlineKeyboardMarkup()
    kb.add(InlineKeyboardButton("â• Ø§ÙØ²ÙˆØ¯Ù† Ø§Ø¯Ù…ÛŒÙ†", callback_data="add_admin"))
    kb.add(InlineKeyboardButton("ğŸ“‹ Ù„ÛŒØ³Øª Ø§Ø¯Ù…ÛŒÙ†â€ŒÙ‡Ø§", callback_data="list_admins"))
    
    await message.answer("ğŸ‘‘ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø¯Ù…ÛŒÙ†â€ŒÙ‡Ø§", reply_markup=kb)

# ==========================
# Ù…Ø¯ÛŒØ±ÛŒØª callback queries
# ==========================

@dp.callback_query_handler(lambda c: c.data == "cancel")
async def cancel_callback(callback_query: types.CallbackQuery, state: FSMContext):
    await callback_query.message.edit_text("âŒ Ø¹Ù…Ù„ÛŒØ§Øª Ù„ØºÙˆ Ø´Ø¯.")
    await state.finish()

@dp.callback_query_handler(lambda c: c.data.startswith("complete_"))
async def complete_order(call: types.CallbackQuery):
    if not is_admin(call.from_user.id):
        await call.answer("âŒ Ø´Ù…Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ù„Ø§Ø²Ù… Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯.", show_alert=True)
        return
    
    order_id = int(call.data.split("_")[1])
    
    try:
        cursor.execute(
            "UPDATE orders SET status = 'completed', completed_at = CURRENT_TIMESTAMP WHERE order_id = ?",
            (order_id,)
        )
        db.commit()
        
        await call.message.edit_text(f"âœ… Ø³ÙØ§Ø±Ø´ #{order_id} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯.")
        
        cursor.execute("SELECT user_id FROM orders WHERE order_id = ?", (order_id,))
        user_id = cursor.fetchone()[0]
        
        try:
            await bot.send_message(user_id, f"âœ… Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ #{order_id} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯. Ø§Ø±Ø² Ø¨Ù‡ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ø²ÛŒ Ø´Ù…Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú¯Ø±Ø¯ÛŒØ¯.")
        except Exception as e:
            logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø·Ù„Ø§Ø¹ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±: {e}")
            
    except sqlite3.Error as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± ØªÚ©Ù…ÛŒÙ„ Ø³ÙØ§Ø±Ø´: {e}")
        await call.answer("âŒ Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± ØªÚ©Ù…ÛŒÙ„ Ø³ÙØ§Ø±Ø´ Ø±Ø® Ø¯Ø§Ø¯.", show_alert=True)

@dp.callback_query_handler(lambda c: c.data.startswith("delete_"))
async def delete_order(call: types.CallbackQuery):
    if not is_admin(call.from_user.id):
        await call.answer("âŒ Ø´Ù…Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ù„Ø§Ø²Ù… Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯.", show_alert=True)
        return
    
    order_id = int(call.data.split("_")[1])
    
    try:
        cursor.execute("SELECT user_id, points_used FROM orders WHERE order_id = ?", (order_id,))
        order_data = cursor.fetchone()
        if order_data:
            user_id, points_used = order_data
            update_points(user_id, points_used)
        
        cursor.execute("DELETE FROM orders WHERE order_id = ?", (order_id,))
        db.commit()
        
        await call.message.edit_text(f"âœ… Ø³ÙØ§Ø±Ø´ #{order_id} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯ Ùˆ Ø§Ù…ØªÛŒØ§Ø² Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù‡ Ø´Ø¯.")
    except sqlite3.Error as e:
        logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø³ÙØ§Ø±Ø´: {e}")
        await call.answer("âŒ Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± Ø­Ø°Ù Ø³ÙØ§Ø±Ø´ Ø±Ø® Ø¯Ø§Ø¯.", show_alert=True)

@dp.callback_query_handler(lambda c: c.data == "add_channel")
async def add_channel_callback(call: types.CallbackQuery, state: FSMContext):
    if not is_admin(call.from_user.id):
        await call.answer("âŒ Ø´Ù…Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ù„Ø§Ø²Ù… Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯.", show_alert=True)
        return
    
    await call.message.answer("ğŸ“¢ Ù„Ø·ÙØ§Ù‹ Ø¢ÛŒØ¯ÛŒ Ú©Ø§Ù†Ø§Ù„ Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª @channel_name Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:")
    await AdminState.waiting_for_channel.set()

@dp.message_handler(state=AdminState.waiting_for_channel)
async def process_channel(message: types.Message, state: FSMContext):
    if not is_admin(message.from_user.id):
        await state.finish()
        return
    
    channel_id = message.text.strip()
    
    if not channel_id.startswith('@'):
        await message.answer("âŒ Ø¢ÛŒØ¯ÛŒ Ú©Ø§Ù†Ø§Ù„ Ø¨Ø§ÛŒØ¯ Ø¨Ø§ @ Ø´Ø±ÙˆØ¹ Ø´ÙˆØ¯. Ù„Ø·ÙØ§Ù‹ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:")
        return
    
    try:
        chat = await bot.get_chat(channel_id)
        channel_name = chat.title
        
        if add_channel(channel_id, channel_name):
            await message.answer(f"âœ… Ú©Ø§Ù†Ø§Ù„ {channel_name} ({channel_id}) Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÙØ²ÙˆØ¯Ù‡ Ø´Ø¯.")
        else:
            await message.answer("âŒ Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ù†Ø§Ù„ Ø±Ø® Ø¯Ø§Ø¯.")
    except Exception as e:
        await message.answer("âŒ Ú©Ø§Ù†Ø§Ù„ ÛŒØ§ÙØª Ù†Ø´Ø¯ ÛŒØ§ Ø±Ø¨Ø§Øª Ø¨Ù‡ Ú©Ø§Ù†Ø§Ù„ Ø¯Ø³ØªØ±Ø³ÛŒ Ù†Ø¯Ø§Ø±Ø¯.")
    
    await state.finish()

@dp.callback_query_handler(lambda c: c.data == "list_channels")
async def list_channels_callback(call: types.CallbackQuery):
    if not is_admin(call.from_user.id):
        await call.answer("âŒ Ø´Ù…Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ù„Ø§Ø²Ù… Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯.", show_alert=True)
        return
    
    channels = get_channels()
    
    if not channels:
        await call.message.answer("ğŸ“­ Ù‡ÛŒÚ† Ú©Ø§Ù†Ø§Ù„ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.")
        return
    
    text = "ğŸ“‹ Ù„ÛŒØ³Øª Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§:\n\n"
    kb = InlineKeyboardMarkup()
    
    for channel_id, channel_name in channels:
        text += f"ğŸ”— {channel_name} ({channel_id})\n"
        kb.add(InlineKeyboardButton(f"âŒ Ø­Ø°Ù {channel_name}", callback_data=f"remove_channel_{channel_id}"))
    
    await call.message.answer(text, reply_markup=kb)

@dp.callback_query_handler(lambda c: c.data.startswith("remove_channel_"))
async def remove_channel_callback(call: types.CallbackQuery):
    if not is_admin(call.from_user.id):
        await call.answer("âŒ Ø´Ù…Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ù„Ø§Ø²Ù… Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯.", show_alert=True)
        return
    
    channel_id = call.data.replace("remove_channel_", "")
    
    if remove_channel(channel_id):
        await call.message.edit_text(f"âœ… Ú©Ø§Ù†Ø§Ù„ {channel_id} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯.")
    else:
        await call.answer("âŒ Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± Ø­Ø°Ù Ú©Ø§Ù†Ø§Ù„ Ø±Ø® Ø¯Ø§Ø¯.", show_alert=True)

@dp.callback_query_handler(lambda c: c.data == "toggle_sub_lock")
async def toggle_sub_lock_callback(call: types.CallbackQuery):
    if not is_admin(call.from_user.id):
        await call.answer("âŒ Ø´Ù…Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ù„Ø§Ø²Ù… Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯.", show_alert=True)
        return
    
    global SUBSCRIPTION_LOCK
    SUBSCRIPTION_LOCK = not SUBSCRIPTION_LOCK
    
    status = "ÙØ¹Ø§Ù„" if SUBSCRIPTION_LOCK else "ØºÛŒØ±ÙØ¹Ø§Ù„"
    await call.answer(f"ğŸ”’ Ù‚ÙÙ„ Ø¹Ø¶ÙˆÛŒØª {status} Ø´Ø¯", show_alert=True)
    await call.message.edit_text(f"ğŸ› ï¸ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§\n\nğŸ”’ Ù‚ÙÙ„ Ø¹Ø¶ÙˆÛŒØª: {status}")

@dp.callback_query_handler(lambda c: c.data == "add_admin")
async def add_admin_callback(call: types.CallbackQuery, state: FSMContext):
    if not is_admin(call.from_user.id):
        await call.answer("âŒ Ø´Ù…Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ù„Ø§Ø²Ù… Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯.", show_alert=True)
        return
    
    await call.message.answer("ğŸ‘‘ Ù„Ø·ÙØ§Ù‹ Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ†â€ŒÙ‡Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:")
    await AdminState.waiting_for_admin.set()

@dp.message_handler(state=AdminState.waiting_for_admin)
async def process_admin(message: types.Message, state: FSMContext):
    if not is_admin(message.from_user.id):
        await state.finish()
        return
    
    try:
        user_id = int(message.text.strip())
        
        if not is_user_exists(user_id):
            await message.answer("âŒ Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¢ÛŒØ¯ÛŒ Ù…Ø¹ØªØ¨Ø± Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:")
            return
        
        try:
            user = await bot.get_chat(user_id)
            username = user.username or ""
            full_name = f"{user.first_name or ''} {user.last_name or ''}".strip()
            
            if add_admin(user_id, username, full_name):
                await message.answer(f"âœ… Ú©Ø§Ø±Ø¨Ø± {full_name} (@{username}) Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ†â€ŒÙ‡Ø§ Ø§ÙØ²ÙˆØ¯Ù‡ Ø´Ø¯.")
                
                try:
                    await bot.send_message(user_id, "ğŸ‰ Ø´Ù…Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø§Ø¯Ù…ÛŒÙ† Ø±Ø¨Ø§Øª Ù…Ù†ØµÙˆØ¨ Ø´Ø¯ÛŒØ¯!")
                except Exception as e:
                    logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø·Ù„Ø§Ø¹ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±: {e}")
            else:
                await message.answer("âŒ Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ø§Ø¯Ù…ÛŒÙ† Ø±Ø® Ø¯Ø§Ø¯.")
        except Exception as e:
            await message.answer("âŒ Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¢ÛŒØ¯ÛŒ Ù…Ø¹ØªØ¨Ø± Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:")
            return
        
    except ValueError:
        await message.answer("âŒ Ø¢ÛŒØ¯ÛŒ Ø¨Ø§ÛŒØ¯ Ø¹Ø¯Ø¯ÛŒ Ø¨Ø§Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:")
        return
    
    await state.finish()

@dp.callback_query_handler(lambda c: c.data == "list_admins")
async def list_admins_callback(call: types.CallbackQuery):
    if not is_admin(call.from_user.id):
        await call.answer("âŒ Ø´Ù…Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ù„Ø§Ø²Ù… Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯.", show_alert=True)
        return
    
    admins = get_admins()
    
    if not admins:
        await call.message.answer("ğŸ“­ Ù‡ÛŒÚ† Ø§Ø¯Ù…ÛŒÙ†ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.")
        return
    
    text = "ğŸ‘‘ Ù„ÛŒØ³Øª Ø§Ø¯Ù…ÛŒÙ†â€ŒÙ‡Ø§:\n\n"
    kb = InlineKeyboardMarkup()
    
    for user_id, username, full_name in admins:
        text += f"ğŸ‘¤ {full_name} (@{username}) - {user_id}\n"
        kb.add(InlineKeyboardButton(f"âŒ Ø­Ø°Ù {full_name}", callback_data=f"remove_admin_{user_id}"))
    
    await call.message.answer(text, reply_markup=kb)

@dp.callback_query_handler(lambda c: c.data.startswith("remove_admin_"))
async def remove_admin_callback(call: types.CallbackQuery):
    if not is_admin(call.from_user.id):
        await call.answer("âŒ Ø´Ù…Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ù„Ø§Ø²Ù… Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯.", show_alert=True)
        return
    
    user_id = int(call.data.replace("remove_admin_", ""))
    
    if remove_admin(user_id):
        await call.message.edit_text(f"âœ… Ø§Ø¯Ù…ÛŒÙ† {user_id} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯.")
        
        try:
            await bot.send_message(user_id, "â„¹ï¸ Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ø´Ù…Ø§ Ø§Ø² Ø±Ø¨Ø§Øª Ø­Ø°Ù Ø´Ø¯.")
        except Exception as e:
            logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø·Ù„Ø§Ø¹ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±: {e}")
    else:
        await call.answer("âŒ Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± Ø­Ø°Ù Ø§Ø¯Ù…ÛŒÙ† Ø±Ø® Ø¯Ø§Ø¯.", show_alert=True)

# ==========================
# Ù…Ø¯ÛŒØ±ÛŒØª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù…ØªÙ†ÛŒ
# ==========================

@dp.message_handler()
async def handle_messages(message: types.Message):
    user_id = message.from_user.id
    logger.info(f"Ù¾ÛŒØ§Ù… Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯Ù‡ Ø§Ø² Ú©Ø§Ø±Ø¨Ø± {user_id}: {message.text}")
    
    if message.chat.type == 'private':
        # Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª Ø¨Ø±Ø§ÛŒ ØªÙ…Ø§Ù… Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
        if not await check_subscription_and_notify(user_id, message=message):
            return
            
        await message.answer("ğŸ¤– Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø±Ø¨Ø§ØªØŒ Ø§Ø² Ù…Ù†ÙˆÛŒ Ø²ÛŒØ± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:", reply_markup=main_menu(user_id))

# ==========================
# Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§Ù‡Ø§
# ==========================

@dp.errors_handler()
async def errors_handler(update: types.Update, exception: Exception):
    logger.error(f"Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¨Ù‡ Ø±ÙˆØ² Ø±Ø³Ø§Ù†ÛŒ: {exception}")
    return True

# ==========================
# Ø§Ø¬Ø±Ø§
# ==========================

if __name__ == "__main__":
    print("ğŸ¤– Ø±Ø¨Ø§Øª Ø¯Ø± Ø­Ø§Ù„ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ...")
    try:
        executor.start_polling(dp, skip_updates=True)
    except Exception as e:
        logger.error(f"Ø®Ø·Ø§ÛŒ Ø¬Ø¯ÛŒ Ø¯Ø± Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª: {e}")